<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Audiobook Scraper</title>

  <!-- UIkit core + icons (for components like spinner & notification) -->
  <link rel="stylesheet" href="/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/uikit@3/dist/js/uikit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uikit@3/dist/js/uikit-icons.min.js"></script>
  <style>
    /* Additional styles for the download modal and log feed */
    #downloadModal .uk-modal-dialog {
      background: rgba(0, 0, 0, 0.8);
    }
    #logFeed {
      max-height: 300px;
      overflow-y: auto;
      margin: 0 auto;
      width: 80%;
      font-family: monospace;
      background: #444;
      color: #fff;
      padding: 10px;
      border-radius: 4px;
    }
    .logLine {
      opacity: 0;
      transition: opacity 0.5s;
    }
    .logLine.visible {
      opacity: 1;
    }
  </style>
</head>
<body class="uk-background-secondary uk-light">

  <div class="uk-container uk-margin-top uk-margin-large-bottom">
    <div uk-grid class="uk-flex-middle uk-margin-bottom">
      <div class="uk-width-expand uk-flex uk-flex-middle">
        <img src="/audiobook.png" alt="Logo" class="logo uk-margin-right">
        <h1 class="uk-heading-line uk-heading-medium"><span>Audiobook Scraper</span></h1>
      </div>
      <div class="uk-width-auto uk-text-right">
        <button id="downloadBtn" class="uk-button uk-button-secondary uk-position-fixed uk-position-top-right uk-margin-large uk-hidden">Download to Library</button>
      </div>
    </div>

    <form id="searchForm" class="uk-grid-small uk-grid" uk-grid>
      <div class="uk-width-expand">
        <input id="searchInput" class="uk-input" type="text" placeholder="Enter search term" required>
      </div>
      <div class="uk-width-auto">
        <button type="submit" class="uk-button uk-button-primary">Search</button>
      </div>
    </form>

    <div id="loadingSpinner" class="uk-flex uk-flex-center uk-margin-large uk-hidden">
      <span uk-spinner="ratio: 2"></span>
    </div>

    <section id="resultsSection" class="uk-margin-top uk-hidden">
      <table class="uk-table uk-table-hover uk-table-divider uk-table-responsive uk-table-middle">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Title</th>
            <th>Details URL</th>
            <th>Metadata</th>
            <th>Image</th>
          </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
      </table>
    </section>
  </div>

  <!-- Download Progress Modal -->
  <div id="downloadModal" class="uk-modal-full" uk-modal>
    <div class="uk-modal-dialog uk-flex uk-flex-center uk-flex-middle">
      <button class="uk-modal-close-full" type="button" uk-close></button>
      <div class="uk-text-center">
        <h2 class="uk-heading-medium">Processing Request</h2>
        <div id="downloadSpinner" class="uk-margin-small">
          <span uk-spinner="ratio: 3"></span>
        </div>
        <div id="logFeed"></div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    function showToast(message, status) {
      UIkit.notification({ message, status, pos: 'bottom-right', timeout: 4000 });
    }

    $(function() {
      $('#searchForm').on('submit', function(e) {
        e.preventDefault();
        let query = $('#searchInput').val().trim();
        if (!query) return;

        $('#resultsTable').empty();
        $('#loadingSpinner').removeClass('uk-hidden');
        $('#downloadBtn').addClass('uk-hidden');
        $('#resultsSection').addClass('uk-hidden');

        $.get('/search', { q: query })
          .done(data => {
            $('#loadingSpinner').addClass('uk-hidden');
            if (!data.length) {
              $('#resultsTable').append('<tr><td colspan="5">No results found.</td></tr>');
            } else {
              data.forEach(item => {
                $('#resultsTable').append(`
                  <tr>
                    <td><input type="checkbox" class="selectRow" data-details-url="${item.detailsUrl}"></td>
                    <td>${item.title}</td>
                    <td><a href="${item.detailsUrl}" target="_blank">${item.detailsUrl}</a></td>
                    <td>${item.metaText}</td>
                    <td>${item.imageUrl ? `<img src="${item.imageUrl}" alt="Book Image" class="result-image">` : ''}</td>
                  </tr>
                `);
              });
            }
            $('#resultsSection').removeClass('uk-hidden');
          })
          .fail(() => {
            $('#loadingSpinner').addClass('uk-hidden');
            showToast('Error fetching results.', 'danger');
          });
      });

      $(document).on('change', '.selectRow', () => {
        $('#downloadBtn').toggleClass('uk-hidden', $('.selectRow:checked').length === 0);
      });

      $('#selectAll').change(function() {
        $('.selectRow').prop('checked', this.checked).trigger('change');
      });

      $('#downloadBtn').click(function() {
        let urls = $('.selectRow:checked').map((_, el) => $(el).data('details-url')).get();
        if (!urls.length) return;
        openDownloadModal();
        $.ajax({
          url: '/download',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ detailsUrls: urls }),
        }).done(() => {
          showToast('Download initiated. Check progress below.', 'success');
        }).fail(() => {
          closeDownloadModal();
          showToast('Error initiating download.', 'danger');
        });
      });
    });

    // Append modal is already in the HTML above.
    function openDownloadModal() {
      UIkit.modal('#downloadModal').show();
      $('#logFeed').empty();
      // Open SSE connection to receive live log updates
      const eventSource = new EventSource('/download/stream');
      window.downloadEventSource = eventSource;
      eventSource.onmessage = function(event) {
        appendLog(event.data);
      };
      eventSource.addEventListener('done', function(event) {
        appendLog('Download complete.');
        setTimeout(() => {
          UIkit.modal('#downloadModal').hide();
          eventSource.close();
        }, 1500);
      });
    }

    function closeDownloadModal() {
      UIkit.modal('#downloadModal').hide();
      if (window.downloadEventSource) {
        window.downloadEventSource.close();
      }
    }

    // Function to append a log message with a fade-in effect
    function appendLog(message) {
      const logLine = $('<div class="logLine"></div>').text(message);
      $('#logFeed').append(logLine);
      // Force reflow for transition to work
      logLine[0].offsetWidth;
      logLine.addClass('visible');
      // Optionally remove the "visible" class after a short delay
      setTimeout(() => {
        logLine.removeClass('visible');
      }, 1000);
    }
  </script>
</body>
</html>
