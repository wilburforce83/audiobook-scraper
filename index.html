<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Audiobook Scraper</title>

  <!-- UIkit core + icons (for components like spinner & notification) -->
  <link rel="stylesheet" href="/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/uikit@3/dist/js/uikit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uikit@3/dist/js/uikit-icons.min.js"></script>
</head>
<body class="uk-background-secondary uk-light">

  <div class="uk-container uk-margin-top uk-margin-large-bottom">
    <div uk-grid class="uk-flex-middle uk-margin-bottom">
      <div class="uk-width-expand uk-flex uk-flex-middle">
        <img src="/audiobook.png" alt="Logo" class="logo uk-margin-right">
        <h1 class="uk-heading-line uk-heading-medium"><span>Audiobook Scraper</span></h1>
      </div>
      <div class="uk-width-auto uk-text-right">
        <button id="downloadBtn" class="uk-button uk-button-secondary uk-position-fixed uk-position-top-right uk-margin-large uk-hidden">Download to Library</button>
      </div>
    </div>

    <form id="searchForm" class="uk-grid-small uk-grid" uk-grid>
      <div class="uk-width-expand">
        <input id="searchInput" class="uk-input" type="text" placeholder="Enter search term" required>
      </div>
      <div class="uk-width-auto">
        <button type="submit" class="uk-button uk-button-primary">Search</button>
      </div>
    </form>

    <div id="loadingSpinner" class="uk-flex uk-flex-center uk-margin-large uk-hidden">
      <span uk-spinner="ratio: 2"></span>
    </div>

    <section id="resultsSection" class="uk-margin-top uk-hidden">
      <table class="uk-table uk-table-hover uk-table-divider uk-table-responsive uk-table-middle">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Title</th>
            <th>Details URL</th>
            <th>Metadata</th>
            <th>Image</th>
          </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
      </table>
    </section>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    function showToast(message, status) {
      UIkit.notification({ message, status, pos: 'bottom-right', timeout: 4000 });
    }

    $(function() {
      $('#searchForm').on('submit', function(e) {
        e.preventDefault();
        let query = $('#searchInput').val().trim();
        if (!query) return;

        $('#resultsTable').empty();
        $('#loadingSpinner').removeClass('uk-hidden');
        $('#downloadBtn').addClass('uk-hidden');
        $('#resultsSection').addClass('uk-hidden');

        $.get('/search', { q: query })
          .done(data => {
            $('#loadingSpinner').addClass('uk-hidden');

            if (!data.length) {
              $('#resultsTable').append('<tr><td colspan="5">No results found.</td></tr>');
            } else {
              data.forEach(item => {
                $('#resultsTable').append(`
                  <tr>
                    <td><input type="checkbox" class="selectRow" data-details-url="${item.detailsUrl}"></td>
                    <td>${item.title}</td>
                    <td><a href="${item.detailsUrl}" target="_blank">${item.detailsUrl}</a></td>
                    <td>${item.metaText}</td>
                    <td>${item.imageUrl ? `<img src="${item.imageUrl}" alt="Book Image" class="result-image">` : ''}</td>
                  </tr>
                `);
              });
            }
            $('#resultsSection').removeClass('uk-hidden');
          })
          .fail(() => {
            $('#loadingSpinner').addClass('uk-hidden');
            showToast('Error fetching results.', 'danger');
          });
      });

      $(document).on('change', '.selectRow', () => {
        $('#downloadBtn').toggleClass('uk-hidden', $('.selectRow:checked').length === 0);
      });

      $('#selectAll').change(function() {
        $('.selectRow').prop('checked', this.checked).trigger('change');
      });

      $('#downloadBtn').click(function() {
        let urls = $('.selectRow:checked').map((_, el) => $(el).data('details-url')).get();
        if (!urls.length) return;

        $('#loadingSpinner').removeClass('uk-hidden');
        $.ajax({
          url: '/download',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ detailsUrls: urls }),
        }).done(() => {
          $('#loadingSpinner').addClass('uk-hidden');
          showToast('Download initiated. Check server logs for status.', 'success');
        }).fail(() => {
          $('#loadingSpinner').addClass('uk-hidden');
          showToast('Error initiating download.', 'danger');
        });
      });
    });
  </script>
</body>
</html>
