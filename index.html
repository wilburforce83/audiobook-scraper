<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Audiobook Scraper</title>

  <!-- UIkit core + icons -->
  <link rel="stylesheet" href="/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/uikit@3/dist/js/uikit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uikit@3/dist/js/uikit-icons.min.js"></script>
  <style>
    /* Modal styles */
    #downloadModal .uk-modal-dialog {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
    }
    /* Center the modal vertically and horizontally */
    #downloadModal {
      display: none;
    }
    /* Log feed: show only the latest message */
    #logFeed {
      margin-top: 20px;
      font-family: monospace;
      font-size: 1.1em;
      color: #333;
      min-height: 2em;
    }
    /* Fade in effect for log updates */
    .fade {
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    .fade.visible {
      opacity: 1;
    }
  </style>
</head>
<body class="uk-background-secondary uk-light">

  <div class="uk-container uk-margin-top uk-margin-large-bottom">
    <div uk-grid class="uk-flex-middle uk-margin-bottom">
      <div class="uk-width-expand uk-flex uk-flex-middle">
        <img src="/audiobook.png" alt="Logo" class="logo uk-margin-right">
        <h1 class="uk-heading-line uk-heading-medium"><span>Audiobook Scraper</span></h1>
      </div>
      <div class="uk-width-auto uk-text-right">
        <button id="downloadBtn" class="uk-button uk-button-secondary uk-position-fixed uk-position-top-right uk-margin-large uk-hidden">Download to Library</button>
      </div>
    </div>

    <form id="searchForm" class="uk-grid-small uk-grid" uk-grid>
      <div class="uk-width-expand">
        <input id="searchInput" class="uk-input" type="text" placeholder="Enter search term" required>
      </div>
      <div class="uk-width-auto">
        <button type="submit" class="uk-button uk-button-primary">Search</button>
      </div>
    </form>

    <div id="loadingSpinner" class="uk-flex uk-flex-center uk-margin-large uk-hidden">
      <span uk-spinner="ratio: 2"></span>
    </div>

    <section id="resultsSection" class="uk-margin-top uk-hidden">
      <table class="uk-table uk-table-hover uk-table-divider uk-table-responsive uk-table-middle">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Title</th>
            <th>Details URL</th>
            <th>Metadata</th>
            <th>Image</th>
          </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
      </table>
    </section>
  </div>

  <!-- Download Progress Modal -->
  <div id="downloadModal" uk-modal>
    <div class="uk-modal-dialog uk-flex uk-flex-center uk-flex-middle">
      <button class="uk-modal-close-default" type="button" uk-close></button>
      <div>
        <h2 class="uk-heading-medium">Processing Request</h2>
        <div id="downloadSpinner" class="uk-margin">
          <span uk-spinner="ratio: 3"></span>
        </div>
        <div id="logFeed"><span class="fade">Waiting for updates...</span></div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    $(function() {
      $('#searchForm').on('submit', function(e) {
        e.preventDefault();
        let query = $('#searchInput').val().trim();
        if (!query) return;

        $('#resultsTable').empty();
        $('#loadingSpinner').removeClass('uk-hidden');
        $('#downloadBtn').addClass('uk-hidden');
        $('#resultsSection').addClass('uk-hidden');

        $.get('/search', { q: query })
          .done(data => {
            $('#loadingSpinner').addClass('uk-hidden');
            if (!data.length) {
              $('#resultsTable').append('<tr><td colspan="5">No results found.</td></tr>');
            } else {
              data.forEach(item => {
                $('#resultsTable').append(`
                  <tr>
                    <td><input type="checkbox" class="selectRow" data-details-url="${item.detailsUrl}"></td>
                    <td>${item.title}</td>
                    <td><a href="${item.detailsUrl}" target="_blank">${item.detailsUrl}</a></td>
                    <td>${item.metaText}</td>
                    <td>${item.imageUrl ? `<img src="${item.imageUrl}" alt="Book Image" class="result-image">` : ''}</td>
                  </tr>
                `);
              });
            }
            $('#resultsSection').removeClass('uk-hidden');
          })
          .fail(() => {
            $('#loadingSpinner').addClass('uk-hidden');
            console.error('Error fetching results.');
          });
      });

      $(document).on('change', '.selectRow', () => {
        $('#downloadBtn').toggleClass('uk-hidden', $('.selectRow:checked').length === 0);
      });

      $('#selectAll').change(function() {
        $('.selectRow').prop('checked', this.checked).trigger('change');
      });

      $('#downloadBtn').click(function() {
        let urls = $('.selectRow:checked').map((_, el) => $(el).data('details-url')).get();
        if (!urls.length) return;
        openDownloadModal();
        $.ajax({
          url: '/download',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ detailsUrls: urls }),
        }).done(() => {
          // No toast notifications; progress is shown via live logs.
          console.log('Download initiated.');
        }).fail(() => {
          closeDownloadModal();
          console.error('Error initiating download.');
        });
      });
    });

    // Opens the modal and establishes an SSE connection for live log updates
    function openDownloadModal() {
      let modal = UIkit.modal('#downloadModal');
      modal.show();
      // Update logFeed with initial text
      updateLog('Processing...');
      
      const eventSource = new EventSource('/download/stream');
      window.downloadEventSource = eventSource;
      
      eventSource.onmessage = function(event) {
        // Replace logFeed text with new message until next event arrives
        updateLog(event.data);
      };
      
      eventSource.addEventListener('done', function(event) {
        updateLog('Download complete.');
        // After receiving final data, close modal after 5 seconds
        setTimeout(() => {
          modal.hide();
          eventSource.close();
        }, 5000);
      });
    }

    function closeDownloadModal() {
      UIkit.modal('#downloadModal').hide();
      if (window.downloadEventSource) {
        window.downloadEventSource.close();
      }
    }

    // Updates the log feed with the current message (replaces previous text)
    function updateLog(message) {
      let logContainer = $('#logFeed');
      logContainer.empty();
      let logLine = $('<span class="fade"></span>').text(message);
      logContainer.append(logLine);
      // Force the fade-in effect by adding 'visible' after a short delay
      setTimeout(() => {
        logLine.addClass('visible');
      }, 50);
    }
  </script>
</body>
</html>
